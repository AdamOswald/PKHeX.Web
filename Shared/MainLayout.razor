@using PKHeX.Core
@inherits LayoutComponentBase
@inject Services.SaveFileService SaveFileService
@inject Services.PokemonEditorService PokemonEditorService
@inject ISnackbar Snackbar

<MudThemeProvider Theme="MyCustomTheme" />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudText Typo="Typo.h5" Class="ml-3">PKHeX.Web</MudText>

        <MudSpacer />

        @if (SaveFileService.SaveFile == null)
        {
            <InputFile id="fileInput" OnChange="UploadSave" hidden accept=".dsv, .sav, .pk7" />

            <MudButton HtmlTag="label" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Filled.CloudUpload"
            class="mx-auto" for="fileInput">
                Upload a save file
            </MudButton>
        }
        else
        {
            <MudText Typo="Typo.h6" Class="ml-3">@SaveFileService.SaveFile.Metadata.BAKName.Replace(".bak", "")</MudText>
        }

        <MudSpacer />

        <MudIconButton Icon="@Icons.Material.Filled.MoreVert" Color="Color.Inherit" Edge="Edge.End" />
    </MudAppBar>
    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>

@code {
    protected override void OnInitialized()
    {
        SaveFileService.OnChange += StateHasChanged;
    }

    MudTheme MyCustomTheme = new MudTheme()
    {
        Palette = new Palette()
        {
            Primary = Colors.Blue.Default,
            Secondary = Colors.Green.Accent4,
            AppbarBackground = Colors.Red.Default,
        }
    };

    private async void UploadSave(InputFileChangeEventArgs e)
    {

        using var memoryStream = new MemoryStream();
        await e.File.OpenReadStream(e.File.Size).CopyToAsync(memoryStream);

        @* if (e.File.Name.EndsWith(".pk7"))
            {
            FileUtil.TryGetPKM(memoryStream.ToArray(), out var pk, "pk7");
            var forms = FormConverter.GetFormList(pk.Species, GameInfo.Strings.types, GameInfo.Strings.forms,
            Array.Empty<string>(), 8);
            return;
            } *@

        FileUtil.TryGetSAV(memoryStream.ToArray(), out var saveFile);

        if (saveFile == null)
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
            Snackbar.Add("The save file could not be recognized.", MudBlazor.Severity.Error);
        }
        else
        {
            SaveFileService.SaveFile = saveFile;
            var pokemon = PKMConverter.GetBlank(saveFile.Generation, saveFile.Version);
            pokemon.Species = 1;
            PokemonEditorService.Pokemon = pokemon;
        }
    }
}