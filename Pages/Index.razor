@using System.IO
@inject Services.SaveFileService SaveFileService
@inject Services.SpriteService SpriteService
@inject IJSRuntime JS
@page "/"

<PageTitle>Index</PageTitle>

@if (SaveFileService.SaveFile == null)
{
  <h1>Please upload a save file.</h1>
}
else
{
  <MudContainer Class="mt-16 px-8" MaxWidth="MaxWidth.Large">
  <MudGrid Justify="Justify.Center">
    <MudItem xs="12" sm="5">
      <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        <MudTabPanel Text="Main">
          <MudText>Content One</MudText>
        </MudTabPanel>
        <MudTabPanel Text="Met">
          <MudText>Content Two</MudText>
        </MudTabPanel>
        <MudTabPanel Text="Stats">
          <MudText>Content Three</MudText>
        </MudTabPanel>
        @* <MudTabPanel Text="Attack">
          <MudText>Content Disabled</MudText>
          </MudTabPanel>
          <MudTabPanel Text="OT/Misc">
          <MudText>Content Disabled</MudText>
          </MudTabPanel> *@
      </MudTabs>
    </MudItem>
    <MudItem xs="12" sm="7">
      <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        <MudTabPanel Text="Box">
          <MudText>Content One</MudText>
        </MudTabPanel>
        <MudTabPanel Text="Party">
          <ul>
            @foreach (var pokemon in SaveFileService.SaveFile.PartyData)
              {
                <li><img src="@SpriteService.GetPokemon(pokemon)" alt="" />@pokemon.Nickname : Lvl.
                  @pokemon.CurrentLevel <img src="@SpriteService.GetItem(pokemon.SpriteItem)" alt="" /></li>
              }
            </ul>
          </MudTabPanel>
          <MudTabPanel Text="Other">
            <MudText>Content Three</MudText>
          </MudTabPanel>
          <MudTabPanel Text="SAV">
            <MudText>Content Disabled</MudText>
          </MudTabPanel>
        </MudTabs>
      </MudItem>
    </MudGrid>
  </MudContainer>
}

@code {
  protected override void OnInitialized()
  {
    SaveFileService.OnChange += StateHasChanged;
  }

  private async Task DownloadFileFromStream()
  {
    var saveFile = SaveFileService.SaveFile;
    var extension = saveFile.Metadata.GetSuggestedExtension();
    var flags = saveFile.Metadata.GetSuggestedFlags(extension);

    var fileStream = new MemoryStream(saveFile.Write(flags));
    var fileName = saveFile.Metadata.BAKName.Replace(".bak", extension).Remove(0, 1);

    using var streamRef = new DotNetStreamReference(stream: fileStream);

    await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
  }
}
